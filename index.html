<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ฟอร์มแจ้งซ่อมสำหรับลูกค้า</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Kanit', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            background-color: #f8f4e9;
            color: #333;
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #6b8e23 0%, #556b2f 100%);
            color: white;
            padding: 20px 15px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.5em;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .header p {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .form-container {
            padding: 20px 15px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 12px;
        }
        
        .form-group label {
            font-weight: 400;
            color: #556b2f;
            margin-bottom: 6px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .required {
            color: #d9534f;
            font-size: 0.9em;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px 12px;
            border: 1px solid #d4d4d4;
            border-radius: 6px;
            font-size: 0.95em;
            transition: all 0.2s ease;
            background: #fff;
            width: 100%;
        }
        
        .form-group textarea {
            min-height: 100px;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #8f9779;
            box-shadow: 0 0 0 2px rgba(143, 151, 121, 0.1);
        }
        
        .section-title {
            color: #556b2f;
            padding: 12px 0;
            margin: 20px 0 12px 0;
            font-weight: 500;
            font-size: 1.05em;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .issue-item {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 12px;
            border-left: 3px solid #8f9779;
        }
        
        .issue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .issue-number {
            background: #8f9779;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 400;
            font-size: 0.8em;
        }
        
        .remove-issue {
            background: #d9534f;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s ease;
        }
        
        .remove-issue:hover {
            background: #c9302c;
        }
        
        .add-issue-btn {
            background: #6b8e23;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 0.95em;
            font-weight: 400;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            justify-content: center;
            width: 100%;
        }
        
        .add-issue-btn:hover {
            background: #556b2f;
        }
        
        .repair-type-selector {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 8px;
        }
        
        .repair-type-option {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 12px;
            border: 1px solid #d4d4d4;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }
        
        .repair-type-option:hover {
            border-color: #8f9779;
        }
        
        .repair-type-option input[type="radio"] {
            margin-top: 2px;
        }
        
        .repair-type-content {
            flex: 1;
        }
        
        .repair-type-title {
            font-weight: 500;
            margin-bottom: 4px;
            color: #2d3748;
            font-size: 0.95em;
        }
        
        .repair-type-desc {
            font-size: 0.8em;
            color: #4a5568;
        }
        
        .repair-type-urgent {
            border-left: 4px solid #d9534f;
        }
        
        .repair-type-normal {
            border-left: 4px solid #f0ad4e;
        }
        
        .repair-type-option input[type="radio"]:checked + .repair-type-content,
        .repair-type-option:has(input[type="radio"]:checked) {
            background-color: #f8f9fa;
        }
        
        .contact-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }
        
        .submit-btn {
            background: #6b8e23;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            font-size: 1em;
            font-weight: 400;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .submit-btn:hover {
            background: #556b2f;
        }
        
        .form-data {
            background: #f5f5f5;
            color: #333;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-family: 'Kanit', sans-serif;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            border: 1px solid #e0e0e0;
            font-size: 0.85em;
            line-height: 1.5;
        }
        
        .info-card {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 3px solid #8f9779;
            font-size: 0.85em;
        }
        
        .info-card h3 {
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 1em;
        }
        
        /* สไตล์สำหรับอัพโหลดรูปภาพ */
        .image-upload {
            margin-top: 12px;
        }
        
        .image-upload-label {
            display: inline-block;
            background: #e9ecef;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            color: #495057;
            border: 1px dashed #adb5bd;
            transition: all 0.2s ease;
            width: 100%;
            text-align: center;
        }
        
        .image-upload-label:hover {
            background: #dee2e6;
        }
        
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        .image-preview {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #dee2e6;
        }
        
        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .remove-image {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(217, 83, 79, 0.8);
            color: white;
            border: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 10px;
        }
        
        /* สไตล์สำหรับ dropdown ประเภทงานซ่อมในแต่ละรายการ */
        .repair-category-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d4d4d4;
            border-radius: 6px;
            font-size: 0.95em;
            background-color: white;
        }
        
        .repair-category-select option {
            padding: 8px 12px;
        }
        
        .other-input {
            margin-top: 8px;
            display: none;
        }
        
        /* ปรับขนาดฟอนต์สำหรับมือถือ */
        @media (min-width: 400px) {
            .form-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap" rel="stylesheet">
    <!-- เพิ่ม SweetAlert CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ฟอร์มแจ้งซ่อม</h1>
            <p>บริษัท ไท พลัส ก่อสร้าง จำกัด | THAI PLUS CONSTRUCTION CO.,LTD.</p>
        </div>
        
        <div class="form-container">
            <div class="info-card">
                <h3>คำแนะนำการกรอกฟอร์ม</h3>
                <p>กรุณากรอกข้อมูลให้ครบถ้วนและระบุตำแหน่งที่เกิดปัญหาให้ชัดเจน เพื่อให้เราสามารถดำเนินการซ่อมแซมได้อย่างรวดเร็ว</p>
                <p style="margin-top: 8px; color: #d9534f; font-weight: 500;">⚠️ กรณีงานซ่อมเร่งด่วน: เป็นกรณีที่อาจก่อให้เกิดความเสียหายต่อทรัพย์สินหรือเป็นอันตรายต่อผู้อยู่อาศัยเท่านั้น</p>
            </div>
            
            <form id="repairForm">
                <!-- ข้อมูลโครงการ -->
                <div class="section-title">
                    ข้อมูลโครงการ
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>วันที่แจ้ง <span class="required">*</span></label>
                        <input type="date" name="reportDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label>ชื่อโครงการ <span class="required">*</span></label>
                        <input type="text" name="projectName" placeholder="ชื่อโครงการ" required>
                    </div>
                </div>
                
                <!-- ข้อมูลผู้แจ้ง -->
                <div class="section-title">
                    ข้อมูลผู้แจ้ง
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>ชื่อผู้แจ้ง <span class="required">*</span></label>
                        <input type="text" name="reporterName" placeholder="ชื่อ-นามสกุล" required>
                    </div>
                    <div class="form-group">
                        <label>ตำแหน่ง</label>
                        <input type="text" name="position" placeholder="ตำแหน่งงาน">
                    </div>
                </div>
                
                <div class="contact-grid">
                    <div class="form-group">
                        <label>เบอร์โทรศัพท์ <span class="required">*</span></label>
                        <input type="tel" name="telephone" placeholder="0xx-xxx-xxxx" required>
                    </div>
                    <div class="form-group">
                        <label>Line ID</label>
                        <input type="text" name="lineId" placeholder="Line ID">
                    </div>
                    <div class="form-group">
                        <label>อีเมล</label>
                        <input type="email" name="email" placeholder="example@email.com">
                    </div>
                </div>
                
                <!-- ประเภทงานซ่อม -->
                <div class="section-title">
                    ประเภทงานซ่อม
                </div>
                
                <div class="repair-type-container">
                    <label class="repair-type-option repair-type-urgent">
                        <input type="radio" name="repairType" value="urgent" id="repairTypeUrgent">
                        <div class="repair-type-content">
                            <div class="repair-type-title">งานซ่อมเร่งด่วน</div>
                            <div class="repair-type-desc">
                                เป็นกรณีที่อาจก่อให้เกิดความเสียหายต่อทรัพย์สินหรือเป็นอันตรายต่อผู้อยู่อาศัย<br>
                                <strong>บริษัทจะติดต่อกลับภายใน 24 ชั่วโมง</strong> และเข้าดำเนินการแก้ไขให้เร็วที่สุด
                            </div>
                        </div>
                    </label>

                    <label class="repair-type-option repair-type-normal">
                        <input type="radio" name="repairType" value="normal" id="repairTypeNormal" checked>
                        <div class="repair-type-content">
                            <div class="repair-type-title">งานซ่อมทั่วไป</div>
                            <div class="repair-type-desc">
                                เป็นกรณีทั่วไปที่ไม่ก่อให้เกิดอันตรายเร่งด่วน<br>
                                <strong>บริษัทจะติดต่อกลับภายใน 3 วัน</strong> และเข้าดำเนินการแก้ไขภายใน 7 วัน
                            </div>
                        </div>
                    </label>
                </div>
                
                <!-- ข้อจำกัดเพิ่มเติม -->
                <div class="section-title">
                    ข้อจำกัดเพิ่มเติม (ถ้ามี)
                </div>
                
                <div class="form-group additional-notes">
                    <textarea name="additionalNotes" placeholder="เช่น เข้าได้เฉพาะวันธรรมดา, ต้องแจ้งล่วงหน้าก่อนเข้าพื้นที่, เวลาเข้าทำงานที่สะดวก เป็นต้น"></textarea>
                </div>
                
                <!-- รายการที่ต้องซ่อม -->
                <div class="section-title">
                    รายละเอียดปัญหาที่ต้องการซ่อม
                </div>
                
                <div id="repairItems">
                    <!-- รายการแรกจะถูกเพิ่มโดย JavaScript -->
                </div>
                
                <button type="button" class="add-issue-btn" onclick="addRepairItem()">
                    เพิ่มรายการซ่อม
                </button>
                
                <button type="submit" class="submit-btn">ส่งคำร้องซ่อม</button>
            </form>
        </div>
    </div>

    <!-- เพิ่ม SweetAlert JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        let repairCount = 0;

        // เพิ่มรายการแรกเมื่อโหลดหน้า
        document.addEventListener('DOMContentLoaded', function() {
            addRepairItem();
            // ตั้งค่าวันที่เป็นวันปัจจุบัน
            document.querySelector('input[name="reportDate"]').valueAsDate = new Date();
        });

        function addRepairItem() {
            repairCount++;
            const repairItemsContainer = document.getElementById('repairItems');
            
            const repairItem = document.createElement('div');
            repairItem.className = 'issue-item';
            repairItem.innerHTML = `
                <div class="issue-header">
                    <div class="issue-number">รายการที่ ${repairCount}</div>
                    ${repairCount > 1 ? '<button type="button" class="remove-issue" onclick="removeRepairItem(this)">ลบรายการ</button>' : ''}
                </div>
                <div class="form-group">
                    <label>ตำแหน่งที่เกิดปัญหา <span class="required">*</span></label>
                    <input type="text" name="location_${repairCount}" placeholder="เช่น ห้องนั่งเล่น ชั้น 2, ห้องครัว, ห้องน้ำชั้นล่าง" required>
                </div>
                <div class="form-group">
                    <label>ประเภทงานซ่อม <span class="required">*</span></label>
                    <select name="repairCategory_${repairCount}" class="repair-category-select" required>
                        <option value="">-- โปรดเลือกประเภทงาน --</option>
                        <option value="Structural Work">งานโครงสร้าง</option>
                        <option value="Electrical / Lighting">งานไฟฟ้า/ระบบแสงสว่าง</option>
                        <option value="Plumbing / Sanitary">งานระบบประปา/สุขาภิบาล</option>
                        <option value="HVAC">งานระบบปรับอากาศ/ระบายอากาศ</option>
                        <option value="Architectural Finishes">งานตกแต่ง/ฝ้า/ผนัง/สี</option>
                        <option value="Doors / Windows / Hardware">งานประตู-หน้าต่าง/อุปกรณ์ฮาร์ดแวร์</option>
                        <option value="CCTV / Network">งานระบบ IT / กล้องวงจรปิด / ระบบเสียง</option>
                        <option value="Flooring">งานพื้น</option>
                        <option value="Other">งานอื่น ๆ</option>
                    </select>
                </div>
                <div id="otherCategoryInput_${repairCount}" class="form-group other-input">
                    <label>ระบุประเภทงานอื่น ๆ:</label>
                    <input type="text" name="otherCategory_${repairCount}" placeholder="โปรดระบุประเภทงาน">
                </div>
                <div class="form-group">
                    <label>รายละเอียดปัญหา <span class="required">*</span></label>
                    <textarea name="issue_${repairCount}" placeholder="อธิบายปัญหาที่เกิดขึ้นให้ละเอียด เช่น ก๊อกน้ำรั่ว, กระเบื้องแตก, ไฟไม่ติด" required></textarea>
                </div>
                <div class="form-group">
                    <label>เมื่อไหร่ที่พบปัญหานี้</label>
                    <input type="text" name="whenFound_${repairCount}" placeholder="เช่น เมื่อสัปดาห์ที่แล้ว, เมื่อเช้านี้, มา 2-3 วันแล้ว">
                </div>
                <div class="form-group">
                    <label>แนบรูปภาพประกอบ</label>
                    <div class="image-upload">
                        <label for="images_${repairCount}" class="image-upload-label">+ เลือกรูปภาพ (สามารถเลือกหลายไฟล์ได้)</label>
                        <input type="file" id="images_${repairCount}" name="images_${repairCount}" multiple accept="image/*" style="display: none;" onchange="previewImages(this, 'preview-container-${repairCount}')">
                        <div id="preview-container-${repairCount}" class="image-preview-container"></div>
                    </div>
                </div>
            `;
            
            repairItemsContainer.appendChild(repairItem);
            
            // เพิ่ม event listener สำหรับ dropdown ประเภทงานซ่อม
            document.querySelector(`select[name="repairCategory_${repairCount}"]`).addEventListener('change', function() {
                const otherSelected = this.value === 'Other';
                document.getElementById(`otherCategoryInput_${repairCount}`).style.display = otherSelected ? 'block' : 'none';
            });
        }

        function removeRepairItem(button) {
            const repairItem = button.closest('.issue-item');
            repairItem.remove();
            updateRepairNumbers();
        }

        function updateRepairNumbers() {
            const repairItems = document.querySelectorAll('.issue-item');
            repairItems.forEach((item, index) => {
                const numberElement = item.querySelector('.issue-number');
                numberElement.textContent = `รายการที่ ${index + 1}`;
            });
            repairCount = repairItems.length;
        }

        // ฟังก์ชันแสดงตัวอย่างรูปภาพก่อนอัพโหลด
        function previewImages(input, previewContainerId) {
            const previewContainer = document.getElementById(previewContainerId);
            previewContainer.innerHTML = '';
            
            if (input.files) {
                for (let i = 0; i < input.files.length; i++) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const previewDiv = document.createElement('div');
                        previewDiv.className = 'image-preview';
                        previewDiv.innerHTML = `
                            <img src="${e.target.result}" alt="รูปภาพประกอบ">
                            <button type="button" class="remove-image" onclick="removeImage(this, '${input.id}', ${i})">×</button>
                        `;
                        previewContainer.appendChild(previewDiv);
                    }
                    
                    reader.readAsDataURL(input.files[i]);
                }
            }
        }

        // ฟังก์ชันลบรูปภาพที่เลือก
        function removeImage(button, inputId, index) {
            const input = document.getElementById(inputId);
            const files = Array.from(input.files);
            files.splice(index, 1);
            
            // สร้าง DataTransfer object ใหม่เพื่ออัพเดทไฟล์ที่เลือก
            const dataTransfer = new DataTransfer();
            files.forEach(file => dataTransfer.items.add(file));
            input.files = dataTransfer.files;
            
            // อัพเดทการแสดงผล
            previewImages(input, button.closest('.image-preview-container').id);
        }

        // ฟังก์ชันส่งฟอร์ม
        document.getElementById('repairForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // แสดง loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="loading-spinner"></span> กำลังส่งข้อมูล...';
            submitBtn.disabled = true;
            
            try {
                const formData = new FormData(this);
                const data = {
                    reportDate: formData.get('reportDate'),
                    projectName: formData.get('projectName'),
                    reporterName: formData.get('reporterName'),
                    position: formData.get('position'),
                    telephone: formData.get('telephone'),
                    lineId: formData.get('lineId'),
                    email: formData.get('email'),
                    repairType: formData.get('repairType') === "urgent" ? "เร่งด่วน" : "ทั่วไป",
                    additionalNotes: formData.get('additionalNotes'),
                    repairItems: []
                };
                
                // รวบรวมข้อมูลรายการซ่อม
                for (let i = 1; i <= repairCount; i++) {
                    const location = formData.get(`location_${i}`);
                    const category = formData.get(`repairCategory_${i}`);
                    const otherCategory = formData.get(`otherCategory_${i}`);
                    const issue = formData.get(`issue_${i}`);
                    const whenFound = formData.get(`whenFound_${i}`);
                    
                    if (location && location.trim() && issue && issue.trim()) {
                        const repairItem = {
                            location: location.trim(),
                            category: category || '',
                            otherCategory: otherCategory ? otherCategory.trim() : '',
                            issue: issue.trim(),
                            whenFound: whenFound ? whenFound.trim() : '',
                            images: []
                        };
                        
                        // เพิ่มรูปภาพถ้ามี
                        const imagesInput = document.querySelector(`input[name="images_${i}"]`);
                        if (imagesInput && imagesInput.files.length > 0) {
                            for (let j = 0; j < imagesInput.files.length; j++) {
                                repairItem.images.push(imagesInput.files[j].name);
                            }
                        }
                        
                        data.repairItems.push(repairItem);
                    }
                }
                
                // สร้าง FormData สำหรับการส่งไฟล์
                const uploadFormData = new FormData();
                
                // เพิ่มข้อมูล JSON
                uploadFormData.append('data', JSON.stringify(data));
                
                // เพิ่มไฟล์รูปภาพ
                for (let i = 1; i <= repairCount; i++) {
                    const imagesInput = document.querySelector(`input[name="images_${i}"]`);
                    if (imagesInput && imagesInput.files.length > 0) {
                        for (let j = 0; j < imagesInput.files.length; j++) {
                            uploadFormData.append(`images_${i}_${j}`, imagesInput.files[j]);
                        }
                    }
                }
                
                // ส่งข้อมูลไปยัง n8n Webhook
                const response = await fetch('https://n8n-p2sw2ng.p2scalw2ng.xyz/webhook/form', {
                    method: 'POST',
                    body: uploadFormData
                });
                
                if (!response.ok) {
                    throw new Error('การส่งข้อมูลล้มเหลว');
                }
                
                const result = await response.json();
                
                // แสดง SweetAlert เมื่อส่งสำเร็จ
                Swal.fire({
                    title: 'ส่งรายการเรียบร้อยแล้ว!',
                    text: 'ทีมงานจะติดต่อกลับภายใน ' + (data.repairType === "เร่งด่วน" ? "24 ชั่วโมง" : "3 วันทำการ"),
                    icon: 'success',
                    confirmButtonText: 'ตกลง',
                    confirmButtonColor: '#6b8e23'
                });
                
                // รีเซ็ตฟอร์มหลังจากส่งสำเร็จ
                this.reset();
                document.getElementById('repairItems').innerHTML = '';
                addRepairItem();
                
            } catch (error) {
                console.error('Error:', error);
                // แสดง SweetAlert เมื่อเกิดข้อผิดพลาด
                Swal.fire({
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถส่งข้อมูลได้: ' + error.message,
                    icon: 'error',
                    confirmButtonText: 'ตกลง',
                    confirmButtonColor: '#d9534f'
                });
            } finally {
                // คืนสถานะปุ่มเป็นปกติ
                submitBtn.innerHTML = originalBtnText;
                submitBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
