<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Event Monitoring Dashboard - Updated</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #f0f2f5; --white: #ffffff; --accept: #2ecc71; --help: #e74c3c; --pending: #f1c40f; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; background: var(--white); padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .kpi-card { background: var(--white); padding: 15px; border-radius: 10px; text-align: center; border-bottom: 4px solid #ccc; }
        .kpi-card.accept { border-color: var(--accept); }
        .kpi-card.help { border-color: var(--help); }
        .kpi-card.pending { border-color: var(--pending); }
        .main-content { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        table { width: 100%; border-collapse: collapse; background: var(--white); border-radius: 10px; overflow: hidden; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #fafafa; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; color: #white; font-weight: bold; color: white; }
        .bg-accept { background: var(--accept); }
        .bg-help { background: var(--help); }
        .bg-pending { background: var(--pending); }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center;">ระบบติดตามสถานะ: <span id="eventTitle">เหตุการณ์ทั้งหมด</span></h2>
    
    <div class="filter-grid">
        <div><label>สาขา</label><select id="fBranch"><option value="all">ทั้งหมด</option></select></div>
        <div><label>แผนก</label><select id="fDept"><option value="all">ทั้งหมด</option></select></div>
        <div><label>ช่วงเวลา (Time)</label><select id="fTime"><option value="all">ทั้งหมด</option></select></div>
        <div><label>เหตุการณ์</label><select id="fEvent"><option value="all">ทั้งหมด</option></select></div>
    </div>

    <div class="kpi-grid">
        <div class="kpi-card"><h3>ทั้งหมด</h3><h2 id="total">0</h2></div>
        <div class="kpi-card accept"><h3>รับทราบแล้ว</h3><h2 id="ok">0</h2></div>
        <div class="kpi-card help"><h3>ขอความช่วยเหลือ</h3><h2 id="sos">0</h2></div>
        <div class="kpi-card pending"><h3>ยังไม่ตอบ</h3><h2 id="wait">0</h2></div>
    </div>

    <div class="main-content">
        <div style="background: white; border-radius: 10px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <h3>รายละเอียด</h3>
            <table id="dataTable">
                <thead><tr><th>ชื่อ</th><th>แผนก/สาขา</th><th>สถานะ</th><th>ข้อความ</th></tr></thead>
                <tbody id="tBody"></tbody>
            </table>
        </div>
        <div style="background: white; border-radius: 10px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <h3>สถิติภาพรวม</h3>
            <canvas id="chartArea"></canvas>
        </div>
    </div>
</div>

<script>
    const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ1fgI4zH2nUvcZjaWLdxl4Kx2RRNBsUsNSFoOGE-cygxg8_oejx1RX0EDlNKZLheZaSUL9OAVotJbg/pub?output=csv';
    let dataList = [];
    let myChart = null;

    async function loadData() {
        const resp = await fetch(url);
        const text = await resp.text();
        const rows = text.split('\n').map(r => r.split(','));
        
        dataList = rows.slice(1).map(r => ({
            name: r[1]?.trim(),
            branch: r[2]?.trim(),
            dept: r[3]?.trim(),
            event: r[4]?.trim(),
            reply: r[5]?.trim(),
            msg: r[6]?.trim(),
            time: r[7]?.trim()
        })).filter(x => x.name);

        initFilters();
        render();
    }

    function initFilters() {
        const setOptions = (id, key) => {
            const select = document.getElementById(id);
            const vals = [...new Set(dataList.map(d => d[key]))].filter(v => v);
            vals.forEach(v => select.innerHTML += `<option value="${v}">${v}</option>`);
            select.onchange = render;
        };
        setOptions('fBranch', 'branch');
        setOptions('fDept', 'dept');
        setOptions('fTime', 'time');
        setOptions('fEvent', 'event');
    }

    function render() {
        const b = document.getElementById('fBranch').value;
        const d = document.getElementById('fDept').value;
        const t = document.getElementById('fTime').value;
        const e = document.getElementById('fEvent').value;

        const filtered = dataList.filter(x => 
            (b === 'all' || x.branch === b) &&
            (d === 'all' || x.dept === d) &&
            (t === 'all' || x.time === t) &&
            (e === 'all' || x.event === e)
        );

        const stats = {
            ok: filtered.filter(x => x.reply === 'Accept').length,
            sos: filtered.filter(x => x.reply === 'Help').length,
            wait: filtered.filter(x => !x.reply || x.reply === 'Pending').length
        };

        document.getElementById('total').innerText = filtered.length;
        document.getElementById('ok').innerText = stats.ok;
        document.getElementById('sos').innerText = stats.sos;
        document.getElementById('wait').innerText = stats.wait;

        const tbody = document.getElementById('tBody');
        tbody.innerHTML = '';
        filtered.forEach(x => {
            const statusClass = x.reply === 'Accept' ? 'bg-accept' : (x.reply === 'Help' ? 'bg-help' : 'bg-pending');
            const statusText = x.reply === 'Accept' ? 'รับทราบ' : (x.reply === 'Help' ? 'ช่วยเหลือ' : 'รอการตอบ');
            tbody.innerHTML += `<tr>
                <td>${x.name}</td>
                <td>${x.dept}<br><small>${x.branch}</small></td>
                <td><span class="badge ${statusClass}">${statusText}</span></td>
                <td style="color:red">${x.reply === 'Help' ? x.msg : '-'}</td>
            </tr>`;
        });

        drawChart(stats);
    }

    function drawChart(s) {
        const ctx = document.getElementById('chartArea').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['รับทราบ', 'ช่วยเหลือ', 'ยังไม่ตอบ'],
                datasets: [{ data: [s.ok, s.sos, s.wait], backgroundColor: ['#2ecc71', '#e74c3c', '#f1c40f'] }]
            }
        });
    }

    loadData();
</script>
</body>
</html>
